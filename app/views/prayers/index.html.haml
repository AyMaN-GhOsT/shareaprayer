%section#home-index.animated.fadeInDown
	.row
		.span8
			%ul.tabs{:data => {:tabs => "tabs"}}
				%li.active
					%a{:href => "#prayers"} Prayer Requests
				%li
					%a{:href => "#new-prayer"} Submit a Prayer Request
				%li
					%a{:href => "#about"} About Share a Prayer

			.tab-content
				.tab-pane.active#prayers
					.prayers{:"data-last" => "#{@prayers.last.created_at.utc}"}
						-unless @prayers.blank?
							=render @prayers
					
					#no-more-prayers.alert-message.warning.hide
						%p
							%strong Uh-oh!
							We don't have any more prayer requests to show you right now.
					
				.tab-pane#new-prayer
					#new-prayer-result
						#posted-email.alert-message.success.hide{:data => {:alert => "alert"}}
							%a.close{:href => "#"} &times;
							%p
								%strong Request Posted!
								We'll be sure to email you a link to it so that you can share it and comment on it with your friends!
								
						#posted-no-email.alert-message.success.hide{:data => {:alert => "alert"}}
							%a.close{:href => "#"} &times;
							%p
								%strong Request Posted!
								Per your request, we have not emailed you a link to your prayer request.
						
						#post-error.alert-message.error.hide{:data => {:alert => "alert"}}
							%a.close{:href => "#"} &times;
							%p
								%strong We encountered an error!
								Please try submitting your prayer request again later. If the problem persists, please email dev@shareaprayer.org.

					#new-prayer-assembly
						#spam-for-jerks.alert-message.info{:data => {:alert => "alert"}}
							%a.close{:href => "#"} &times;
							%p
								%strong Spamming is not tolerated at Share a Prayer!
								We're all about creating a community and bringing people together. We believe that spam destroys community and trust. We will never share your email address or spam you. See our #{link_to "privacy policy", privacy_path} for more details.
						
						%p Want to share a prayer request with the world? Fill out the following form and we'll be sure to put your request online right away.
						
						%br
						=form_for :prayer, :url => { :controller => "prayers", :action => "create" }, :html => { :id => "prayer-form" }, :remote => true do |f|
							.clearfix
								=f.label :name, "First Name"
								.input
									=f.text_field :name, :class => "span2", :placeholder => "Joe", :id => "prayer_name", :required => "required"
									%input.btn#anonymous_name{:type => "button", :value => "I'd prefer to be anonymous"}
									%span.help-block We'll display your first name below your prayer request.

							.clearfix
								=f.label :email, "Your Email"
								.input
									=f.email_field :email, :class => "span5", :placeholder => "john@example.com", :id => "prayer_email", :required => "required"
									%span.help-block We will never share your email address or spam you.
									
							.clearfix.hide#form_profile_icon
								%label Profile Icon
								.input
									.alert-message{:data => {:alert => "alert"}}
										%a.close{:href => "#"} &times;
										%p
											%strong This is your profile icon
											that will display next to your prayer request. We use Gravatar to display this image. Gravatar is an online service that provides you with a profile image that you can use all over the internet. If you have a Gravatar you should see it below, otherwise you should see the default big "G" on a blue background. You can get a Gravatar at #{link_to "gravatar.com", "http://gravatar.com/"}.
									%span#prayer_gravatar
										=image_tag "http://www.gravatar.com/avatar/?size=100"

							.clearfix
								=f.label :request, "Prayer Request"
								.input
									=f.text_area :request, :class => "span5", :placeholder => "Mauris iaculis porttitor posuere. Praesent id metus massa.", :id => "prayer_request", :rows => "5", :required => "required", :maxlength => "160"
									%span.help-block Please keep it within 160 characters

							.clearfix
								.input
									%ul.inputs-list
										%li
											%label
												=f.check_box :email_me, {:checked => true}
												%span Yes, please email me a link to my prayer request's page

							.actions
								%input.btn.primary{:name => "commit", :type => "submit", :value => "Post Request"}
								%input.btn{:name => "reset", :type => "reset", :value => "Cancel"}
				
				.tab-pane#about
					%h3 The Story
					=render 'shared/about_story'
					
					%br
						
					%h3 The Mission
					=render 'shared/about_mission'
					
					%br
					
					%h3 The Team
					= render 'shared/about_team'
			
			=render 'shared/footer'

-# Gritter notificaitons, new prayer form validations, and continuous scrolling
:javascript
	$(document).ready(function(){
		#{add_gritter("Share a Prayer is a new, minimalistic way to share prayer requests online. Check out the \"About Share a Prayer\" tab for more on our mission.", :title => "Welcome to Share a Prayer!", :sticky => true, :class_name => "gritter-light")}
		#{extend_gritter :fade_in_speed => 2000}
	});
	
	// Blur action for email address field triggers Gravatar load/reload
	$('#prayer_email').blur(function() {
		$('#prayer_gravatar').html($.gravatar($(this).val(), {size: '100'}));
		$('#form_profile_icon').slideDown();
	});
	
	// Click action for anonymous button
	$('#anonymous_name').click(function() {
		$('#prayer_name').val("Anonymous").addClass('uneditable-input').attr('readonly', true);
		$('#anonymous_name').val("We will respect your privacy").attr('disabled', 'disabled');
		$('#prayer_name').nextAll(".help-block").text("Your request will be posted anonymously");
	});
	
	// Disable submit button on submit
	$('#prayer-form').submit(function(){
		$('input[type=submit]', this).attr('disabled', 'disabled');
		$('input[type=reset]', this).attr('disabled', 'disabled');
		$("#post-error").fadeOut("slow");
	});
	
	// Bind to ajax:error event to display feeback
	$("#prayer-form").bind("ajax:error", function() {
		$("#post-error").slideDown("slow");
		$('input[type="submit"]').removeAttr('disabled');
		$('input[type="reset"]').removeAttr('disabled');
	});
	
	// New prayer form validation
	// SEE: https://github.com/twitter/bootstrap/issues/202
	// SEE: Edit starting on line 648 of assets/javascripts/jquery.validate.js to make help-block show up.
	$('#prayer-form').validate({
	    errorClass:'error',
	    validClass:'success',
	    errorElement:'span',
	    highlight: function (element, errorClass, validClass) { 
				$(element).parents("div[class='clearfix']").addClass(errorClass).removeClass(validClass); 
	    }, 
	    unhighlight: function (element, errorClass, validClass) { 
				$(element).parents(".error").removeClass(errorClass).addClass(validClass); 
	    },
			invalidHandler: function(form, validator) {
				$('input[type="submit"]').removeAttr('disabled');
				$('input[type="reset"]').removeAttr('disabled');
			}
	});	
	
	// Infinite scrolling
	(function() {
	  loading = false,
	  finish = false;

	  function nearBottomOfPage() {
	    return $(window).scrollTop() > $(document).height() - $(window).height() - 200;
	  }
	
	  function onPrayersTab() {
	    if ($("#prayers").hasClass("active")) {
				return true;
			}
			else {
				return false
			}
	  }

	  function finish() {
	    finish = true;
	  }

	  $(window).scroll(function(){
	    if (loading) {
	      return;
	    }

	    if(nearBottomOfPage() && onPrayersTab() && !finish) {
	      loading=true;
				
				#{add_gritter("Loading more prayer requests", :title => "Loading...", :time => 2000)}
				
				$.ajax({
					url: '/',
					data: {
						last: $('.prayers').data('last')
					},
					dataType: 'script',
				  success: function() {
	          loading=false;
	        }
				});
	    }
	  });
	}());